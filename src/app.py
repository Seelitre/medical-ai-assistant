import gradio as gr
import sys
import os
import json

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–µ
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from model import MedicalTreatmentPlanner

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
print("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏...")
planner = MedicalTreatmentPlanner()

def process_patient_history(history_text):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
    if not history_text.strip():
        return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏", "{}"
    
    try:
        result = planner.generate_with_citations(history_text)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
        output = f"""
## üìã –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ù–´–ô –ü–õ–ê–ù –õ–ï–ß–ï–ù–ò–Ø
{result['plan']}

---

## üìö –û–ë–û–°–ù–û–í–ê–ù–ò–Ø
"""
        
        for i, citation in enumerate(result['citations'], 1):
            output += f"\n{i}. {citation.get('regimen', '')}\n"
            output += f"   üìñ {citation.get('source', '')}\n"
            if citation.get('nccn'):
                output += f"   üåê {citation.get('nccn')}\n"
            if citation.get('evidence'):
                output += f"   üî¨ {citation.get('evidence')}\n"
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        dev_info = json.dumps(result['extracted_info'], ensure_ascii=False, indent=2)
        
        return output, dev_info
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞: {str(e)}", "{}"

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–±–µ–∑ theme –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ)
with gr.Blocks(title="üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç") as demo:
    gr.Markdown("""
    # üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–µ—á–µ–Ω–∏—è
    
    –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º 
    –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
    
    ‚öïÔ∏è **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
    1. –í–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞
    2. –°–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ—á–µ—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–¥–∏–∞–≥–Ω–æ–∑, –ª–∏–Ω–∏—é —Ç–µ—Ä–∞–ø–∏–∏, –º–∞—Ä–∫–µ—Ä—ã)
    3. –ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    """)
    
    with gr.Row():
        with gr.Column(scale=2):
            history_input = gr.Textbox(
                label="üìù –ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞",
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏ –∑–¥–µ—Å—å...",
                lines=15
            )
            
            with gr.Row():
                submit_btn = gr.Button("üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è", variant="primary")
                clear_btn = gr.Button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å")
        
        with gr.Column(scale=2):
            plan_output = gr.Markdown(
                value="*–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç...*"
            )
    
    with gr.Row():
        with gr.Accordion("üî¨ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)", open=False):
            dev_info = gr.JSON(label="–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
    
    # –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    gr.Markdown("### üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å—Ç–æ—Ä–∏–π –±–æ–ª–µ–∑–Ω–∏")
    
    examples = [
        [
            """–ü–∞—Ü–∏–µ–Ω—Ç 65 –ª–µ—Ç, —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–∫ –ø—Ä–∞–≤–æ–≥–æ –ª–µ–≥–∫–æ–≥–æ (–ø–ª–æ—Å–∫–æ–∫–ª–µ—Ç–æ—á–Ω—ã–π) IIIB —Å—Ç.
–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ 2 –ª–∏–Ω–∏–π —Ç–µ—Ä–∞–ø–∏–∏. –ò–º–º—É–Ω–æ—Ç–µ—Ä–∞–ø–∏—è –ø–µ–º–±—Ä–æ–ª–∏–∑—É–º–∞–±–æ–º - –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ.
PD-L1 70%, ECOG 1. –¢—Ä–µ–±—É–µ—Ç—Å—è 3 –ª–∏–Ω–∏—è —Ç–µ—Ä–∞–ø–∏–∏."""
        ],
        [
            """–ü–∞—Ü–∏–µ–Ω—Ç–∫–∞ 48 –ª–µ—Ç, —Ä–∞–∫ –º–æ–ª–æ—á–Ω–æ–π –∂–µ–ª–µ–∑—ã, –ª—é–º–∏–Ω–∞–ª—å–Ω—ã–π B, HER2-–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π.
–ú–µ—Ç–∞—Å—Ç–∞–∑—ã –≤ –∫–æ—Å—Ç–∏, –ø–µ—á–µ–Ω—å. –ü—Ä–æ–≤–µ–¥–µ–Ω–æ 5 –ª–∏–Ω–∏–π –•–¢. –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ.
–í—ã—è–≤–ª–µ–Ω–∞ –º—É—Ç–∞—Ü–∏—è PIK3CA. –°—Ç–∞—Ç—É—Å ECOG 1."""
        ],
        [
            """–ü–∞—Ü–∏–µ–Ω—Ç 36 –ª–µ—Ç, –º–µ–ª–∞–Ω–æ–º–∞ –∫–æ–∂–∏, BRAF V600E –º—É—Ç–∞—Ü–∏—è.
–ú–µ—Ç–∞—Å—Ç–∞–∑—ã –≤ –ª–µ–≥–∫–∏–µ, –ø–µ—á–µ–Ω—å, –≥–æ–ª–æ–≤–Ω–æ–π –º–æ–∑–≥. –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –∏–º–º—É–Ω–æ—Ç–µ—Ä–∞–ø–∏—è (–Ω–∏–≤–æ–ª—É–º–∞–±+–∏–ø–∏–ª–∏–º—É–º–∞–±) - –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ.
–°—Ç–∞—Ç—É—Å ECOG 1. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –ª–∏–Ω–∏—è —Ç–µ—Ä–∞–ø–∏–∏."""
        ]
    ]
    
    gr.Examples(
        examples=examples,
        inputs=history_input
    )
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    submit_btn.click(
        fn=process_patient_history,
        inputs=history_input,
        outputs=[plan_output, dev_info]
    )
    
    clear_btn.click(
        fn=lambda: ("", {}),
        inputs=[],
        outputs=[plan_output, dev_info]
    )
    
    gr.Markdown("""
    ---
    ### üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏
    * –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ú–∏–Ω–∑–¥—Ä–∞–≤–∞ –†–§ (2024)
    * NCCN Guidelines v.2.2024
    * ESMO Clinical Practice Guidelines
    
    ‚ö†Ô∏è **–î–∏—Å–∫–ª–µ–π–º–µ—Ä**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–º–æ—â–∏ –≤—Ä–∞—á–∞–º –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç 
    –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
    """)

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ)
if __name__ == "__main__":
    print("="*60)
    print("üöÄ –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ô AI-–ê–°–°–ò–°–¢–ï–ù–¢ –ó–ê–ü–£–©–ï–ù!")
    print("="*60)
    print("üåê –û—Ç–∫—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏ –ø–æ –∞–¥—Ä–µ—Å—É:")
    print("   http://localhost:7860")
    print("   http://127.0.0.1:7860")
    print("üìù –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏ Ctrl+C")
    print("="*60)
    
    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã
    ports = [7860, 7861, 7862]
    
    for port in ports:
        try:
            print(f"–ü—Ä–æ–±—É–µ–º –ø–æ—Ä—Ç {port}...")
            demo.launch(
                server_name="127.0.0.1",
                server_port=port,
                share=False,
                debug=False,
                quiet=True
            )
            break
        except Exception as e:
            print(f"–ü–æ—Ä—Ç {port} –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π...")
            continue